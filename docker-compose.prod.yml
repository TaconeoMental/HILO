x-worker-prod: &worker_prod
  environment:
    - FLASK_ENV=production
  volumes:
    - ./data:/app/data
  restart: unless-stopped

services:
  backend:
    environment:
    - FLASK_ENV=production
    volumes:
    - ./data:/app/data
    command: gunicorn --bind 0.0.0.0:8000 --workers 4 --threads 2 --timeout 120 --access-logfile - --error-logfile - app:app
    restart: unless-stopped

  worker-prepare:
    <<: *worker_prod

  worker-transcribe:
    <<: *worker_prod

  worker-photos:
    <<: *worker_prod

  worker-llm:
    <<: *worker_prod

  db:
    restart: unless-stopped

  redis:
    restart: unless-stopped

  frontend:
    build: ./frontend
    environment:
      - NODE_ENV=production
      - API_INTERNAL_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - internal_net

  nginx:
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

