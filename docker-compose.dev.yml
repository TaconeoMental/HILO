x-worker-dev: &worker_dev
  volumes:
    - ./backend:/app
    - /app/.venv
  environment:
    - FLASK_ENV=development

services:
  backend:
    volumes:
      - ./backend:/app
      - /app/.venv
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
    command: flask run --host=0.0.0.0 --port=8000 --reload --debug

  worker-prepare:
    <<: *worker_dev

  worker-transcribe:
    <<: *worker_dev

  worker-photos:
    <<: *worker_dev

  worker-llm:
    <<: *worker_dev

  db:
    ports:
      - "5432:5432"

  redis:
    ports:
      - "6379:6379"

  frontend:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - API_INTERNAL_URL=http://backend:8000
    command: sh -lc "npm install && npm run dev -- --hostname 0.0.0.0 --port 3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - internal_net

  nginx:
    ports:
      - "3000:80"
    volumes:
      - ./infra/nginx/conf.d/app.dev.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/nginx/conf.d/includes:/etc/nginx/conf.d/includes:ro
